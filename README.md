# Примитивная база данных

Простой инструмент командной строки для управления таблицами с поддержкой базовых типов столбцов (`int`, `str`, `bool`). Проект использует Python и Poetry для управления зависимостями.

## Установка

1. **Клонирование репозитория**:
   ```bash
   git clone git@github.com:o-nastasia/project-2_Osadchuk_M25-555.git
   cd project-2_Osadchuk_M25-555
   ```

2. **Установка Poetry** (если ещё не установлено):
   ```bash
   pip install poetry
   ```
   или
   ```bash
   brew install poetry
   ```

3. **Установка зависимостей**:
   ```bash
   make install
   ```

4. **Запуск приложения**:
   ```bash
   make database
   ```

## Управление таблицами

Инструмент предоставляет интерфейс командной строки для управления таблицами, хранящимися в файле метаданных JSON (`db_meta.json`). Ниже приведены доступные команды и их использование.

### Команды
- **create_table** `<имя_таблицы> <столбец1:тип> ...`: Создаёт новую таблицу с указанным именем и столбцами. Каждый столбец должен соответствовать формату `<имя_столбца>:<тип>`, где `тип` может быть `int`, `str` или `bool`. Столбец `ID:int` добавляется автоматически, если не указан.
- **list_tables**: Отображает список всех существующих таблиц.
- **drop_table** `<имя_таблицы>`: Удаляет указанную таблицу.
- **exit**: Выход из программы.
- **help**: Отображает справочное сообщение с доступными командами.

[![asciicast](https://asciinema.org/a/1d96mpowDd1IAfA7i3I6FhPrt.svg)](https://asciinema.org/a/1d96mpowDd1IAfA7i3I6FhPrt)

## Операции с данными
Помимо управления таблицами, инструмент поддерживает полный набор CRUD-операций (Create, Read, Update, Delete) для работы с данными внутри таблиц. Данные каждой таблицы хранятся в отдельных JSON-файлах в директории `data/` (например, `data/users.json` для таблицы `users`). Результаты команд `select` и `info` отображаются в форматированном виде с использованием библиотеки `prettytable`.

### Команды
- **insert_into** `<имя_таблицы> values (<значение1>, <значение2>, ...)`: Создает новую запись в указанной таблице. Количество значений должно соответствовать количеству столбцов (за исключением автоматически генерируемого столбца `ID`). Значения должны соответствовать типам столбцов (`int`, `str` или `bool`). Строковые значения должны быть заключены в кавычки.
- **select_from** `<имя_таблицы>`: Извлекает и отображает все записи из указанной таблицы.
- **select_from** `<имя_таблицы> where <столбец> = <значение>`: Извлекает и отображает записи из указанной таблицы, соответствующие заданному условию.
- **update** `<имя_таблицы> set <столбец> = <новое_значение> where <столбец_условия> = <значение_условия>`: Обновляет записи в указанной таблице, изменяя значение указанного столбца для записей, соответствующих условию.
- **delete_from** `<имя_таблицы> where <столбец> = <значение>`: Удаляет записи из указанной таблицы, соответствующие заданному условию.
- **info** `<имя_таблицы>`: Выводит информацию о таблице, включая список столбцов и их типы, а также количество записей.

[![asciicast](https://asciinema.org/a/h3oIHd37TH5AlA9mX6xM6G2vX.svg)](https://asciinema.org/a/h3oIHd37TH5AlA9mX6xM6G2vX)

## Декораторы и улучшения кода

Для повышения надежности, читаемости и производительности в проекте реализованы декораторы и механизм кэширования с использованием замыканий. Эти улучшения централизуют обработку ошибок, добавляют подтверждение для опасных операций, логируют время выполнения и оптимизируют повторяющиеся запросы.

### Реализованные декораторы

- **`handle_db_errors`**:
  - Централизует обработку ошибок для операций с базой данных.
  - Перехватывает исключения `FileNotFoundError` (отсутствие файла данных), `KeyError` (обращение к несуществующей таблице или столбцу), `ValueError` (ошибки валидации типов) и прочие непредвиденные ошибки.
  - Применяется к функциям `create_table`, `drop_table`, `insert`, `select`, `update` и `delete` в модуле `core.py`.
  - Устраняет необходимость дублирования блоков `try-except` в этих функциях, делая код чище и проще для поддержки.

- **`confirm_action(action_name)`**:
  - Запрашивает подтверждение пользователя перед выполнением потенциально опасных операций, таких как удаление таблицы или записи.
  - Пример вывода: `Вы уверены, что хотите выполнить удаление таблицы? [y/n]:`.
  - Если пользователь не вводит `y`, операция отменяется.
  - Применяется к функциям `drop_table` и `delete` в модуле `core.py`.

- **`log_time`**:
  - Замеряет и выводит время выполнения функций в консоль в формате: `Функция <имя_функции> выполнилась за X.XXX секунд`.
  - Использует `time.monotonic()` для точного измерения времени.
  - Применяется к "медленным" операциям, работающим с файлами: `insert` и `select` в модуле `core.py`.

### Кэширование с помощью замыкания

- **Функция `create_cacher`**:
  - Создает механизм кэширования с использованием замыкания для хранения результатов запросов.
  - Возвращает две функции:
    - `cache_result(key, value_func)`: Проверяет, есть ли результат в кэше по ключу. Если результат отсутствует, вызывает `value_func`, сохраняет результат в кэш и возвращает его.
    - `clear_cache(table_name)`: Очищает кэш для указанной таблицы, что необходимо при изменении данных (например, после `insert`, `update` или `delete`).
  - Интегрировано в операцию `select` для кэширования результатов запросов, что значительно ускоряет повторные запросы с одинаковыми параметрами.
  - Пример вывода при использовании кэша: `Результат получен из кэша для ключа: <ключ>`.

[![asciicast](https://asciinema.org/a/cW1JMx0sccwQ8E5ENem84ku7w.svg)](https://asciinema.org/a/cW1JMx0sccwQ8E5ENem84ku7w)

## Пример использования
1. Запустите программу:
   ```bash
   make database
   ```

2. Создайте таблицу `users` со столбцами `name:str`, `age:int`, `is_active:bool`:
   ```
   Введите команду: create_table users name:str age:int is_active:bool
   ```
   Вывод:
   ```
   Таблица "users" успешно создана со столбцами: ID:int, name:str, age:int, is_active:bool
   ```

3. Вставьте новую запись в таблицу `users`:
   ```
   Введите команду: insert_into users values ("Sergei", 28, true)
   ```
   Вывод:
   ```
   Запись с ID=1 успешно добавлена в таблицу "users".
   ```

4. Выберите все записи из таблицы `users`:
   ```
   Введите команду: select_from users
   ```
   Вывод:
   ```
   +----+--------+-----+-----------+
   | ID |  name  | age | is_active |
   +----+--------+-----+-----------+
   | 1  | Sergei | 28  |    True   |
   +----+--------+-----+-----------+
   ```

5. Выберите записи, где `age = 28`:
   ```
   Введите команду: select_from users where age = 28
   ```
   Вывод:
   ```
   +----+--------+-----+-----------+
   | ID |  name  | age | is_active |
   +----+--------+-----+-----------+
   | 1  | Sergei | 28  |    True   |
   +----+--------+-----+-----------+
   ```

6. Обновите возраст пользователя с именем `Sergei`:
   ```
   Введите команду: update users set age = 29 where name = "Sergei"
   ```
   Вывод:
   ```
   Запись с ID=1 в таблице "users" успешно обновлена.
   ```

7. Удалите запись с `ID = 1`:
   ```
   Введите команду: delete from users where ID = 1
   ```
   Вывод:
   ```
   Запись с ID=1 успешно удалена из таблицы "users".
   ```

8. Выведите информацию о таблице `users`:
   ```
   Введите команду: info users
   ```
   Вывод:
   ```
   +----+--------+-----+-----------+
   | ID |  name  | age | is_active |
   +----+--------+-----+-----------+ |
   +----+--------+-----+-----------+
   ```

9. Выйдите из программы:
   ```
   Введите команду: exit
   ```

## Автор

Анастасия Осадчук (o-nastasia) группа M25-555.